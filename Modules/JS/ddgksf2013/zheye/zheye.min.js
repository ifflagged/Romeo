const scriptName="哲也同学",blockedUsersKey="zhihu_blocked_users",currentUserInfoKey="zhihu_current_userinfo",keywordBlockKey="zhihu_keyword_block",blackAnswersIdKey="zhihu_black_answers",zheyeServerKey="zheye_server_url",defaultAnswerBlockedUsers=["会员推荐","盐选推荐"],keywordMaxCount=1e3,$=MagicJS("哲也同学","INFO"),testUrl=e=>new RegExp(e).test($.request.url);function getUserInfo(){const e={id:"default",is_vip:!1};try{const{id:t=e.id,is_vip:r=e.is_vip}=$.data.read(currentUserInfoKey,{});return{id:t,is_vip:r}}catch(t){return $.logger.error(`获取用户信息出现异常：${t}`),e}}function modifyAppTabConfig(){try{if(!1===$.data.read("zhihu_settings_app_conf",!1))return null;const e=JSON.parse($.response.body),t=["follow","recommend","hot"];return e.tab_list=e.tab_list?.filter((e=>t.includes(e.tab_type)))||[],$.logger.debug(`修改推荐页Tab：${JSON.stringify(e)}`),{body:JSON.stringify(e)}}catch(e){$.logger.error(`移除推荐页Tab出现异常：${e}`)}}function unlockBlockedKeywords(){const e=(e,t)=>{const r={"Cache-Control":"no-cache, no-store, must-revalidate, private, max-age=0",Connection:"keep-alive","Content-Type":"application/json;charset=utf-8",Pragma:"no-cache","Referrer-Policy":"no-referrer-when-downgrade",Server:"CLOUD ELB 1.0.0",Vary:"Accept-Encoding","X-Cache-Lookup":"Cache Miss","x-cdn-provider":"tencent"};return $.env.isQuanX?{body:e,headers:r,status:t}:{response:{body:e,headers:r,status:{"HTTP/1.1 200 OK":200,"HTTP/1.1 400 Bad Request":400}[t]}}};try{if(!1===$.data.read("zhihu_settings_blocked_keywords",!0))return null;const t=getUserInfo(),r=$.data.read(keywordBlockKey,null,t.id)||[];let n=decodeURIComponent($.request.body).match(/keyword=(.*)/),o=n?n[1]:"";if($.logger.debug(`准备操作本地关键词：${o}`),"GET"===$.request.method){const t=JSON.stringify({success:!0,is_vip:!0,kw_min_length:2,kw_max_length:100,kw_max_count:1e3,data:r});return $.logger.debug(`获取本地脚本屏蔽关键词：\n${r.join("、")}`),e(t,"HTTP/1.1 200 OK")}if("POST"===$.request.method){if(r.includes(o)){return e(JSON.stringify({error:{message:"关键词已存在",code:100002}}),"HTTP/1.1 400 Bad Request")}r.push(o),$.data.write(keywordBlockKey,r,t.id);const n=JSON.stringify({success:!0});return $.logger.debug(`添加本地脚本屏蔽关键词“${o}”`),e(n,"HTTP/1.1 200 OK")}if("DELETE"===$.request.method){n=decodeURIComponent($.request.url).match(/keyword=(.*)/),o=n?n[1]:"";const s=r.filter((e=>e!==o));$.data.write(keywordBlockKey,s,t.id);const i=JSON.stringify({success:!0});return $.logger.debug(`删除本地脚本屏蔽关键词：“${o}”`),e(i,"HTTP/1.1 200 OK")}}catch(e){$.logger.error(`关键词屏蔽操作出现异常：${e}`)}}function processUserInfo(){try{const e=JSON.parse($.response.body);if($.data.write(blackAnswersIdKey,[]),!e?.id||void 0===e?.vip_info?.is_vip)return $.logger.warning("没有获取到本次登录用户信息，如未对功能造成影响，请忽略此日志。"),null;{const t={id:e.id,is_vip:e.vip_info.is_vip??!1};if($.data.write(currentUserInfoKey,t),!1!==$.data.read("zhihu_settings_blocked_keywords")&&!1===e.vip_info.is_vip)return e.vip_info.is_vip=!0,e.vip_info.vip_type=2,e.vip_info.vip_icon={url:"https://picx.zhimg.com/v2-aa8a1823abfc46f14136f01d55224925.jpg?source=88ceefae",night_mode_url:"https://picx.zhimg.com/v2-aa8a1823abfc46f14136f01d55224925.jpg?source=88ceefae"},{body:JSON.stringify(e)}}}catch(e){return $.logger.error(`获取当前用户信息出现异常：${e}`),null}}function manageBlackUser(){const e=getUserInfo();let t={},r=$.data.read(blockedUsersKey,"",e.id);r="object"==typeof r?r:{},defaultAnswerBlockedUsers.forEach((e=>{r[e]=t[e]="00000000000000000000000000000000"})),$.logger.debug(`当前用户id：${e.id}，脚本黑名单：${JSON.stringify(r)}`);try{if("GET"===$.request.method){$.request.url.includes("offset")||(r=t,$.logger.debug("脚本黑名单已清空，请滑动至黑名单末尾保证重新获取完成。"),$.notification.post("开始同步黑名单数据，请滑动至黑名单末尾，直至弹出“同步成功”的通知。"));let n=JSON.parse($.response.body);n?.data?.forEach((({name:e,id:t})=>{"[已重置]"!==e&&e&&t&&(r[e]=t)})),$.data.write(blockedUsersKey,r,e.id),n?.paging?.is_end&&($.notification.post(`同步黑名单数据成功！当前黑名单共${Object.keys(r).length-defaultAnswerBlockedUsers.length}人。\n脚本内置黑名单${defaultAnswerBlockedUsers.length}人。`),$.logger.debug(`脚本黑名单内容：${JSON.stringify(r)}。`))}else if("POST"===$.request.method){let{name:t,id:n}=JSON.parse($.response.body);t&&n&&(r[t]=n,$.data.write(blockedUsersKey,r,e.id),$.logger.debug(`${t}写入脚本黑名单成功，当前脚本黑名单数据：${JSON.stringify(r)}`),$.notification.post(`已将用户“${t}”写入脚本黑名单。`))}else if("DELETE"===$.request.method){if(JSON.parse($.response.body).success){let t=$.request.url.match(/^https:\/\/api\.zhihu\.com\/settings\/blocked_users\/([0-9a-zA-Z]*)/)[1];if(t)for(let n in r)if(r[n]===t){delete r[n],$.data.write(blockedUsersKey,r,e.id),$.logger.debug(`${n}移出脚本黑名单成功，当前脚本黑名单数据：${JSON.stringify(r)}`),$.notification.post(`已将用户“${n}”移出脚本黑名单！`);break}}}}catch(e){$.logger.error(`操作黑名单失败，异常信息：${e}`),$.notification.post("操作黑名单失败，执行异常，请查阅日志。")}}function autoInsertBlackList(){try{if(!1===$.data.read("zhihu_settings_blocked_users",!0))return null;const e=JSON.parse($.response.body);if(e.name&&e.id&&!0===e.is_blocking){const t=getUserInfo();let r=$.data.read(blockedUsersKey,"",t.id);r=("object"==typeof r&&r)??{},r[e.name]||($.logger.debug(`当前需要加入黑名单的用户Id：${e.id}，用户名：${e.name}`),r[e.name]=e.id,$.data.write(blockedUsersKey,r,t.id),$.logger.debug(`${e.name}写入脚本黑名单成功，当前脚本黑名单数据：${JSON.stringify(r)}`),$.notification.post(`已自动将用户“${e.name}”写入脚本黑名单。`))}return{body:JSON.stringify(e)}}catch(e){$.logger.error(`去除MCN信息出现异常：${e}`)}}function removeMoments(){try{const e=$.data.read("zhihu_settings_blocked_users",!1);if(!1===e)return null;let t=JSON.parse($.response?.body||"{}");const r=getUserInfo();let n={};return n=$.data.read(blockedUsersKey,{},r.id)||{},t.data=t.data?.filter((t=>{const r=t.target?.author;return!(e&&r&&n.hasOwnProperty(r))}))||[],{body:JSON.stringify(t)}}catch(e){$.logger.error(`关注列表去广告出现异常：${e}`)}}function _setRecommendTag(e,t){e?.common_card?.footline?.elements&&e.common_card.footline.elements.unshift({tag:{color:"MapText06A",text:t,type:"MASK_BORDER"}})}function getAllTagConfigs(){let e={};try{const t=$.data.read("zhihu_settings_custom_tags","");$.logger.debug(`自定义标签配置：${t}`),e=t.split(";").filter((e=>""!==e.trim())).map((e=>e.split(":"))).reduce(((e,t)=>(2!==t.length?$.logger.error(`自定义标签配置错误：${t.join(":")}`):e[t[0]]=t[1],e)),{});const r={"付费内容":"查看完整内容|查看全部章节","营销推广":"ad-link-card|xg.zhihu.com|营销平台","购物推广":"mcn-link-card",...e};return $.logger.debug(`合并后的标签配置：${JSON.stringify(r)}`),r}catch(e){$.notification.post("推荐页设置自定义标签出现异常，请检查标签配置"),$.logger.error(`推荐页设置自定义标签出现异常，请检查标签配置：${e}`)}return e}async function _setContentTagByCloud(e,t){const r=$.data.read(zheyeServerKey);if(r){$.logger.debug(`向云端请求以下链接\n${e.join("\n")}`);const n=`${r}/api/v1.1/answer/links`;$.logger.debug(`服务端地址\n${n}`);const o={links:e,custom_tags:getAllTagConfigs()};await $.http.post({url:n,headers:{"Content-Type":"application/json"},body:o}).then((e=>{$.logger.debug(`云端探测结果<${typeof e.body}>\n${JSON.stringify(e.body)}`);for(let r=0;r<e.body.length;r++)try{let n=e.body[r];""!==n&&_setRecommendTag(t[r],n)}catch(e){$.logger.error(e)}})).catch((e=>{$.logger.error(`云端请求出现异常\n${JSON.stringify(e)}`)}))}else $.notification.post("未设置服务端地址，无法进行内容探测。\n请配置服务端地址，或使用本地探测。")}async function _setContentTagByLocal(e,t){$.logger.debug(`将在本地请求以下回答：${e.join(",")}`);const r=getAllTagConfigs();function n(t){return new Promise((n=>{e[t]||n(""),$.logger.debug(`本地请求回答内容：${e[t]}`),$.http.get({url:e[t],timeout:1e3}).then((e=>{let t=!1;$.logger.debug(`检测标签配置:\n${JSON.stringify(r)}`);for(let[o,s]of Object.entries(r))if($.logger.debug(`检测内容：${o}，正则：${s}`),"string"!=typeof s&&(s=String(s)||""),s&&new RegExp(s).test(e.body)){n(o),t=!0;break}t||n("")})).catch((e=>{$.logger.error(`本地请求出现异常\n${JSON.stringify(e)}`),n("")}))}))}let o=[];for(let t=0;t<e.length;t++)o.push(n(t));await Promise.all(o).then((e=>{$.logger.info(`本地探测结果<${e.length}>\n${JSON.stringify(e)}`);for(let r=0;r<e.length;r++)try{let n=e[r];""!==n&&_setRecommendTag(t.data[r],n)}catch(e){$.logger.error(e)}}))}async function removeRecommend(){if(!$.response.body)return $.logger.error("推荐列页去广告无法获取响应体"),null;try{const e={recommend_stream:$.data.read("zhihu_settings_recommend_stream",!1),remove_article:$.data.read("zhihu_settings_remove_article",!1),remove_advertorial:$.data.read("zhihu_settings_remove_advertorial",!0),remove_pin:$.data.read("zhihu_settings_remove_pin",!0),blocked_users:$.data.read("zhihu_settings_blocked_users",!1),blocked_keywords:$.data.read("zhihu_settings_blocked_keywords",!0),check_paid_content:$.data.read("zhihu_settings_check_paid_content",!1),request_content:$.data.read("zhihu_settings_request_content","local")},t=getUserInfo(),r=e.blocked_keywords&&$.data.read(keywordBlockKey,"",t.id)||[],n=e.blocked_users&&$.data.read(blockedUsersKey,"",t.id)||{},o=$.response.body instanceof Uint8Array?(new TextDecoder).decode($.response.body):$.response.body,s=JSON.parse(o);if(s.data=s.data.filter((t=>!isFiltered(t,JSON.stringify(t),e,r,n))),s.fresh_text){const e=parseInt((s.fresh_text.match(/\d+/)||["0"])[0]);s.fresh_text=e>0?`刷新 ${e} 条内容，过滤后剩余 ${s.data.length} 条`:`过滤后剩余 ${s.data.length} 条`}return{body:JSON.stringify(s)}}catch(e){return $.logger.error(`推荐列表去广告出现异常：${e}`),null}}function isFiltered(e,t,r,n,o){if("market_card"===e.type||"feed_advert"===e.type||"SvipActivity"===e.extra?.type||t.includes("盐选推荐")||e.hasOwnProperty("ad"))return $.logger.debug(`${t}匹配到广告`),!0;if(r.remove_advertorial&&(e.hasOwnProperty("promotion_extra")||t.includes(" · 商品介绍")))return $.logger.debug(`${t}匹配到软文`),!0;if(r.remove_article&&t.search(/"type"\s*:\s*"article"/i)>=0)return $.logger.debug(`${t}匹配到文章`),!0;if(r.recommend_stream&&t.search(/"(type|style|content_type)"\s*:\s*"(zvideo|BIG_IMAGE|drama|StyleVideo)"/i)>=0)return $.logger.debug(`${t}匹配到流媒体`),!0;if(r.remove_pin&&t.search(/type"\s*:\s*"pin"/i)>=0)return $.logger.debug(`${t}匹配到想法`),!0;if(r.blocked_keywords&&n.length>0){if(n.some((r=>{const n=t.search(r)>=0;if(n&&$.isDebug&&Array.isArray(e.children)){const t=e.children.find((e=>"Text"===e.id))?.text,n=e.children.find((e=>"text_pin_summary"===e.id))?.text;$.logger.debug(`匹配关键字：\n${r}\n标题：\n${t}\n内容：\n${n}`)}return n})))return!0}if(r.blocked_users&&Object.keys(o).length>0){const t=e.children?.find((e=>"Line"===e.type&&"LineAuthor_default"===e.style))?.elements.find((e=>"Text"===e.type))?.text||"";if(o.hasOwnProperty(t))return!0}return!1}function removeQuestions(){try{let e=JSON.parse($.response.body);delete e.ad_info;const t=getUserInfo();let r=$.data.read(blockedUsersKey,"",t.id)||{};const n=$.data.read("zhihu_settings_blocked_users",!1);$.logger.debug(`当前黑名单列表: ${JSON.stringify(r)}`);let o=$.data.read(blackAnswersIdKey,[])||[];e?.data&&(e.data=e.data.filter((e=>{const{target:t,target:{id:s="",author:{name:i=""}={}}={}}=e,a=r.hasOwnProperty(i),d=n&&a;return t&&(e.target.visible_only_to_author=!1,e.target.is_visible=!0,e.target.is_copyable=!0),d&&!o.includes(s.toString())&&(o.push(s.toString()),$.notification.debug(`记录黑名单用户${i}的回答Id:${s}`)),!d}))),$.data.write(blackAnswersIdKey,o);const s=JSON.stringify(e);return $.logger.debug(`修改后的回答列表数据：${s}`),{body:s}}catch(e){$.logger.error(`回答列表去广告出现异常：${e}`)}}function insertContentTip(){const e=JSON.parse($.response.body??"{}"),t=getAllTagConfigs();if(e?.endorsement){for(const[r,n]of Object.entries(t))if($.logger.debug(`检测内容：${n}，标签：${r}`),"string"==typeof n&&new RegExp(n).test($.response.body)){$.logger.debug(`内容：\n ${$.response.body}\n匹配到标签：\n${r}`);const t={action_url:"https://github.com/blackmatrix7/ios_rule_script/tree/master/script/zheye",background_color:{alpha:.1,group:"GBL01A"},elements:[{content:r,font_color:{alpha:1,group:"GBL07A"},font_size:13,is_bold:!0,max_line:1,type:"TEXT"}],sub_elements:[],sub_elements_type:"DESCRIPTION",za:{block_text:"ThanksForInvitingLabel",text:"",type:"text"}};e.endorsement.unshift(t);break}}else if(e?.content_card_list)for(const[r,n]of Object.entries(t))if($.logger.debug(`检测内容：${n}，标签：${r}`),"string"==typeof n&&new RegExp(n).test($.response.body)){$.logger.debug(`内容：\n ${$.response.body}\n匹配到标签：\n${r}`);const t={card_type:"km-paid-answer-header",dynamic_id:":km-sku-card-head",extra_info:`{"title_line":\n                          {"scene":"ANSWER_DETAIL",\n                           "copyright":"${r}",\n                           "style":"v2",\n                           "content_type":"ANSWER"\n                         }`};e.content_card_list.unshift(t);break}return e}function removeComment(){try{const e=$.response?.body;if(!e)return null;let t=JSON.parse(e);if(t.ad_info={},!$.data.read("zhihu_settings_blocked_users",!1))return{body:JSON.stringify(t)};const{id:r}=getUserInfo(),n=$.data.read(blockedUsersKey,{},r)||{},o=e=>{e.is_delete=!0,e.can_reply=!1,e.can_like=!1,e.author.name="[黑名单用户]",e.author.avatar_url="https://picx.zhimg.com/v2-abed1a8c04700ba7d72b45195223e0ff_xll.jpg",e.author.exposed_medal={}},s=e=>{e.name="[黑名单用户]",e.avatar_url="https://picx.zhimg.com/v2-abed1a8c04700ba7d72b45195223e0ff_xll.jpg",e.exposed_medal={}},i=e=>e.map((e=>{const{name:t}=e.author,r=e.reply_to_author?.name||"",a=n[t],d=n[r];return(a||d)&&(a&&o(e),d&&s(e.reply_to_author)),e.child_comments&&(e.child_comments=i(e.child_comments)),e}));if(t.root){const{name:e}=t.root.author;n[e]&&o(t.root)}return t.data&&(t.data=i(t.data)),{body:JSON.stringify(t)}}catch(e){$.logger.error(`去除评论广告出现异常：${e}`)}}function removeMarketingMsg(){try{if(!1===$.data.read("zhihu_settings_marketing_msg",!0))return null;const e=JSON.parse($.response?.body||"{}");e?.column_head?.forEach((e=>{"column_head_entry_invite"===e?.id&&(e.text=`您有${e.unread_count}条新的邀请回答`,e.unread_count=0)}));const t=["超赞包小助手","知乎活动助手","考研记事本","创作者小助手"];return e.data=e?.data?.reduce(((e,r)=>{const n=r?.content?.title||r?.detail_title;if("官方账号消息"===n){const e=r?.unread_count||0;r.content.text=e>0?`未读消息${e}条`:"全部消息已读",r.is_read=!0,r.unread_count=0}return t.includes(n)||e.push(r),e}),[])||[],{body:JSON.stringify(e)}}catch(e){return $.logger.error(`屏蔽官方营销消息出现异常：${e}`),null}}function removeHotListAds(){let e=null;try{if(!1===$.data.read("zhihu_settings_hot_list",!0))return null;if($.response.body){let t=JSON.parse($.response.body);"data"in t&&(t.data=t.data.filter((e=>"hot_list_feed"===e.type||"hot_list_feed_video"===e.type))),e={body:JSON.stringify(t)}}}catch(e){$.logger.error(`去除热榜广告出现异常：${e}`)}return e}function removeKeywordAds(){try{if(!1===$.data.read("zhihu_settings_preset_words",!0))return null;const e=$.response?.body;if(!e)return null;const t=JSON.parse(e),r=t?.preset_words?.words;return r?(t.preset_words.words=r.filter((e=>"general"===e.type)),{body:JSON.stringify(t)}):null}catch(e){return $.logger.error(`去除预置关键字广告异常：${e}`),null}}function removeQueryAds(){try{const e=$.response?.body;if(!e)return null;const t=JSON.parse(e);return t?.recommend_queries?.queries?(t.recommend_queries.queries=t.recommend_queries.queries.filter((e=>!e.hasOwnProperty("ad_commercial_json"))),{body:JSON.stringify(t)}):null}catch(e){return $.logger.error(`去除猜你想搜广告异常：${e}`),null}}function modifyAnswersNextRender(){try{const e=$.response?.body;if(!e)return null;const t=JSON.parse(e),r=getUserInfo(),n=$.data.read("zhihu_settings_blocked_users",!1);let o={};return n&&(o=$.data.read(blockedUsersKey,{},r.id)||{},$.logger.debug(`脚本黑名单用户：\n${JSON.stringify(o)}`)),t.data=t.data.filter((e=>{const{ad_info:t={},biz_type_list:r=[],type:s="",adjson:i="",author:{fullname:a}={}}=e||{},d=t?.data||1!==r?.length||"answer"!==r?.[0]||"ad"===s||i,l=n&&o.hasOwnProperty(a);return $.logger.debug(`用户${a}是否在黑名单中：${l}`),!(d||n&&l)})),{body:JSON.stringify(t)}}catch(e){$.logger.error(`屏蔽回答信息流黑名单用户及广告：${e}`)}}function removeAnswerOrArticleAd(){$.logger.debug("开始移除回答页广告");try{const e=insertContentTip();return delete e.third_business,$.logger.debug(JSON.stringify(e)),{body:JSON.stringify(e)}}catch(e){return $.logger.error(`移除回答页广告出现异常：${e}`),null}}function AsyncFunction(){return"[object AsyncFunction]"===Object.prototype.toString.call(this)}const urlHandlers={resp_handlers:{"^https:\\/\\/api\\.zhihu\\.com\\/people\\/self$":processUserInfo,"^https:\\/\\/api\\.zhihu\\.com\\/root\\/tab\\/v2":modifyAppTabConfig,"^https:\\/\\/(api|web-render)\\.zhihu\\.com\\/topstory\\/recommend":removeRecommend,"^https:\\/\\/api\\.zhihu\\.com\\/questions\\/\\d+\\/feeds":removeQuestions,"^https:\\/\\/api\\.zhihu\\.com\\/next-render\\?":modifyAnswersNextRender,"^https:\\/\\/api\\.zhihu\\.com\\/notifications\\/v3\\/message":removeMarketingMsg,"^https:\\/\\/api\\.zhihu\\.com\\/comment_v5\\/(answers|pins|comments?|articles)\\/\\d+\\/(root|child)_comment":removeComment,"^https:\\/\\/(page-info|api)\\.zhihu\\.com\\/(answers|articles)\\/v2\\/\\d+":removeAnswerOrArticleAd,"^https:\\/\\/api\\.zhihu\\.com\\/articles\\/v\\d\\/\\d+":removeAnswerOrArticleAd,"^https:\\/\\/api\\.zhihu\\.com\\/people\\/\\d+":autoInsertBlackList,"^https:\\/\\/api\\.zhihu\\.com\\/moments_v3\\?":removeMoments,"^https?:\\/\\/api\\.zhihu\\.com\\/topstory\\/hot-lists":removeHotListAds,"^https:\\/\\/api\\.zhihu\\.com\\/search\\/preset_words":removeKeywordAds,"^https:\\/\\/api\\.zhihu\\.com\\/search\\/recommend_query":removeQueryAds,"^https:\\/\\/api\\.zhihu\\.com\\/settings\\/blocked_users":manageBlackUser},req_handlers:{"^https:\\/\\/api\\.zhihu\\.com\\/feed-root\\/block":unlockBlockedKeywords}};async function handleRequest(e){let t=null;for(const r in urlHandlers[e])if($.logger.debug(`当前处理的URL：${$.request.url}，匹配规则：${r}`),$.logger.debug(`匹配结果${testUrl(r)}`),testUrl(r)){$.logger.debug(`当前处理的URL：${$.request.url}，匹配规则：${r}`);const n=urlHandlers[e][r];t=n instanceof AsyncFunction?await n():n();break}return t}function MagicJS(e="MagicJS",t="INFO"){return new class{constructor(e,t){if(this._startTime=Date.now(),this.version="3.0.0",this.scriptName=e,this.env=(()=>{const e="undefined"!=typeof $loon,t="undefined"!=typeof $task,r="undefined"!=typeof module,n="undefined"!=typeof $httpClient&&!e,o="undefined"!=typeof $storm,s="undefined"!=typeof $environment&&void 0!==$environment["stash-build"],i="undefined"!=typeof importModule;return{isLoon:e,isQuanX:t,isNode:r,isSurge:n,isStorm:o,isStash:s,isSurgeLike:n||e||o||s,isScriptable:i,get name(){return e?"Loon":t?"QuantumultX":r?"NodeJS":n?"Surge":i?"Scriptable":"unknown"},get build(){return n?$environment["surge-build"]:s?$environment["stash-build"]:o?$storm.buildVersion:void 0},get language(){if(n||s)return $environment.language},get version(){return n?$environment["surge-version"]:s?$environment["stash-version"]:o?$storm.appVersion:r?process.version:void 0},get system(){return n?$environment.system:r?process.platform:void 0},get systemVersion(){if(o)return $storm.systemVersion},get deviceName(){if(o)return $storm.deviceName}}})(),this.logger=((e,t="INFO")=>{let r=t;const n={SNIFFER:6,DEBUG:5,INFO:4,NOTIFY:3,WARNING:2,ERROR:1,CRITICAL:0,NONE:-1},o={SNIFFER:"",DEBUG:"",INFO:"",NOTIFY:"",WARNING:"❗ ",ERROR:"❌ ",CRITICAL:"❌ ",NONE:""},s=(t,s="INFO")=>{n[r]<n[s.toUpperCase()]||console.log(`[${s}] [${e}]\n${o[s.toUpperCase()]}${t}\n`)};return{getLevel:()=>r,setLevel:e=>{r=e},sniffer:e=>{s(e,"SNIFFER")},debug:e=>{s(e,"DEBUG")},info:e=>{s(e,"INFO")},notify:e=>{s(e,"NOTIFY")},warning:e=>{s(e,"WARNING")},error:e=>{s(e,"ERROR")},retry:e=>{s(e,"RETRY")}}})(e,t),this.http="function"==typeof MagicHttp?MagicHttp(this.env,this.logger):void 0,this.data="function"==typeof MagicData?MagicData(this.env,this.logger):void 0,this.notification="function"==typeof MagicNotification?MagicNotification(this.scriptName,this.env,this.logger,this.http):void 0,this.utils="function"==typeof MagicUtils?MagicUtils(this.env,this.logger):void 0,this.qinglong="function"==typeof MagicQingLong?MagicQingLong(this.env,this.data,this.logger):void 0,void 0!==this.data){let e=this.data.read("magic_loglevel");const t=this.data.read("magic_bark_url");e&&this.logger.setLevel(e.toUpperCase()),t&&this.notification.setBark(t)}}get isRequest(){return"undefined"!=typeof $request&&"undefined"==typeof $response}get isResponse(){return"undefined"!=typeof $response}get isDebug(){return"DEBUG"===this.logger.level}get request(){return"undefined"!=typeof $request?$request:void 0}get response(){return"undefined"!=typeof $response?($response.hasOwnProperty("status")&&($response.statusCode=$response.status),$response.hasOwnProperty("statusCode")&&($response.status=$response.statusCode),$response):void 0}done=(e={})=>{this._endTime=Date.now();let t=(this._endTime-this._startTime)/1e3;this.logger.debug(`SCRIPT COMPLETED: ${t} S.`),"undefined"!=typeof $done&&$done(e)}}(e,t)}function MagicNotification(e,t,r,n){let o=null,s=null;function i(t=e,i="",a="",d=""){if(void 0===n||void 0===n.post)throw"Bark notification needs to import MagicHttp module.";let l={url:o,headers:{"content-type":"application/json; charset=utf-8"},body:{title:t,body:i?`${i}\n${a}`:a,device_key:s}};n.post(l).catch((e=>{r.error(`Bark notify error: ${e}`)}))}return{post:function(n=e,a="",d="",l=""){l=(e=>{try{let r={};if("string"==typeof e)t.isLoon?r={openUrl:e}:t.isQuanX?r={"open-url":e}:t.isSurge&&(r={url:e});else if("object"==typeof e)if(t.isLoon)r.openUrl=e["open-url"]?e["open-url"]:"",r.mediaUrl=e["media-url"]?e["media-url"]:"";else if(t.isQuanX)r=e["open-url"]||e["media-url"]?e:{};else if(t.isSurge){let t=e["open-url"]||e.openUrl;r=t?{url:t}:{}}return r}catch(e){r.error(`通知选项转换失败${e}`)}return e})(l),1===arguments.length&&(n=e,a="",d=arguments[0]),r.notify(`title:${n}\nsubTitle:${a}\nbody:${d}\noptions:${"object"==typeof l?JSON.stringify(l):l}`),t.isSurge?$notification.post(n,a,d,l):t.isLoon?l?$notification.post(n,a,d,l):$notification.post(n,a,d):t.isQuanX&&$notify(n,a,d,l),o&&s&&i(n,a,d)},debug:function(t=e,n="",o="",s=""){"DEBUG"===r.getLevel()&&(1===arguments.length&&(t=e,n="",o=arguments[0]),this.post(t,n,o,s))},bark:i,setBark:e=>{try{let t=e.replace(/\/+$/g,"");o=`${/^https?:\/\/([^/]*)/.exec(t)[0]}/push`,s=/\/([^\/]+)\/?$/.exec(t)[1]}catch(e){r.error(`Bark url error: ${e}.`)}}}}function MagicData(e,t){let r={fs:void 0,data:{}};if(e.isNode){r.fs=require("fs");try{r.fs.accessSync("./magic.json",r.fs.constants.R_OK|r.fs.constants.W_OK)}catch(e){r.fs.writeFileSync("./magic.json","{}",{encoding:"utf8"})}r.data=require("./magic.json")}const n=(e,t)=>"object"!=typeof t&&e===t,o=e=>"true"===e||"false"!==e&&(void 0===e?null:e),s=(e,t,r,n)=>{if(r)try{"string"==typeof e&&(e=JSON.parse(e)),e=!0===e.magic_session?e[r]:null}catch{e=null}if("string"==typeof e&&"null"!==e)try{e=JSON.parse(e)}catch{}return!1===n&&e&&!0===e.magic_session&&(e=null),null==e&&null!=t&&(e=t),e=o(e)},i=e=>{if("string"==typeof e){let t={};try{t=JSON.parse(e);const r=typeof t;("object"!==r||t instanceof Array||"bool"===r||null===t)&&(t={})}catch{}return t}return e instanceof Array||null==e||e!=e||"boolean"==typeof e?{}:e},a=(e,t=null,n="",o=!1,i=null)=>{let a=i||r.data;return a&&void 0!==a[e]&&null!==a[e]?val=a[e]:val=n?{}:null,val=s(val,t,n,o),val},d=(r,n=null,o="",i=!1,d=null)=>{let l="";return d||e.isNode?l=a(r,n,o,i,d):(e.isSurgeLike?l=$persistentStore.read(r):e.isQuanX&&(l=$prefs.valueForKey(r)),l=s(l,n,o,i)),t.debug(`READ DATA [${r}]${o?`[${o}]`:""} <${typeof l}>\n${JSON.stringify(l)}`),l},l=(n,o,s="",a=null)=>{if(void 0===o||o!=o)return!1;e.isNode||"boolean"!=typeof o&&"number"!=typeof o||(o=String(o));let d="";if(a||e.isNode?d=((e,t,n="",o=null)=>{let s=o||r.data;if(s=i(s),n){let r=i(s[e]);r.magic_session=!0,r[n]=t,s[e]=r}else s[e]=t;return null!==o&&(o=s),s})(n,o,s,a):s?(e.isSurgeLike?d=$persistentStore.read(n)?$persistentStore.read(n):d:e.isQuanX&&(d=$prefs.valueForKey(n)?$prefs.valueForKey(n):d),d=i(d),d.magic_session=!0,d[s]=o):d=o,d&&"object"==typeof d&&(d=JSON.stringify(d,null,4)),t.debug(`WRITE DATA [${n}]${s?`[${s}]`:""} <${typeof o}>\n${JSON.stringify(o)}`),!a){if(e.isSurgeLike)return $persistentStore.write(d,n);if(e.isQuanX)return $prefs.setValueForKey(d,n);if(e.isNode)try{return r.fs.writeFileSync("./magic.json",d),!0}catch(e){return t.error(e),!1}}return!0};return{read:d,write:l,del:(n,o="",s=null)=>{let a={};if(s||e.isNode)a=((e,t,n)=>{let o=n||r.data;return o=i(o),t?(obj=i(o[e]),delete obj[t],o[e]=obj):delete o[e],n&&(n=o),o})(n,o,s),s?s=a:r.fs.writeFileSync("./magic.json",JSON.stringify(a,null,4));else if(o){e.isSurgeLike?a=$persistentStore.read(n):e.isQuanX&&(a=$prefs.valueForKey(n)),a=i(a),delete a[o];const t=JSON.stringify(a,null,4);l(n,t)}else{if(e.isStorm)return $persistentStore.remove(n);if(e.isSurgeLike)return $persistentStore.write(null,n);if(e.isQuanX)return $prefs.removeValueForKey(n)}t.debug(`DELETE KEY [${n}]${o?`[${o}]`:""}`)},update:(e,t,r,s=n,i=null)=>{t=o(t);if(!0===s(d(e,null,r,!1,i),t))return!1;{const o=l(e,t,r,i);let a=d(e,null,r,!1,i);return s===n&&"object"==typeof a?o:s(t,a)}},allSessions:(e,r=null)=>{let n={},o=d(e,null,null,!0,r);return o=i(o),!0===o.magic_session&&(n={...o},delete n.magic_session),t.debug(`READ ALL SESSIONS [${e}] <${typeof n}>\n${JSON.stringify(n,null,4)}`),n},allSessionNames:(e,r=null)=>{let n=[],o=d(e,null,null,!0,r);return o=i(o),n=!0!==o.magic_session?[]:Object.keys(o).filter((e=>"magic_session"!==e)),t.debug(`READ ALL SESSIONS [${e}] <${typeof n}>\n${JSON.stringify(n,null,4)}`),n},defaultValueComparator:n,convertToObject:i}}function MagicHttp(e,t){let r;if(e.isNode){const e=require("axios");r=e.create()}class n{constructor(e=!0){this.handlers=[],this.isRequest=e}use(e,r,n){return"function"==typeof e&&t.debug(`Register fulfilled ${e.name}`),"function"==typeof r&&t.debug(`Register rejected ${r.name}`),this.handlers.push({fulfilled:e,rejected:r,synchronous:!(!n||"boolean"!=typeof n.synchronous)&&n.synchronous,runWhen:n?n.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}forEach(e){this.handlers.forEach((t=>{null!==t&&e(t)}))}}function o(r){let n={...r};if(n.params&&!e.isNode){let e=Object.keys(n.params).map((e=>{const t=encodeURIComponent(e);return n.url=n.url.replace(new RegExp(`${e}=[^&]*`,"ig"),""),n.url=n.url.replace(new RegExp(`${t}=[^&]*`,"ig"),""),`${t}=${encodeURIComponent(n.params[e])}`})).join("&");n.url.indexOf("?")<0&&(n.url+="?"),/(&|\?)$/g.test(n.url)||(n.url+="&"),n.url+=e,delete n.params,t.debug(`Params to QueryString: ${n.url}`)}return n}const s=(e,t=null)=>{if(e){let r={...e,config:e.config||t,status:e.statusCode||e.status,body:e.body||e.data,headers:e.headers||e.header};if("string"==typeof r.body)try{r.body=JSON.parse(r.body)}catch{}return delete r.data,r}return e},i=(e,r=null)=>{if(e&&e.status>=400)return t.debug(`Raise exception when status code is ${e.status}`),{name:"RequestException",message:`Request failed with status code ${e.status}`,config:r||e.config,response:e}},a={request:new n,response:new n(!1)};let d=[],l=[],u=!0;function c(e){return e=o(e),t.debug(`HTTP ${e.method.toUpperCase()}:\n${JSON.stringify(e)}`),e}function g(e){try{e=e?s(e):e,t.sniffer(`HTTP ${e.config.method.toUpperCase()}:\n${JSON.stringify(e.config)}\nSTATUS CODE:\n${e.status}\nRESPONSE:\n${"object"==typeof e.body?JSON.stringify(e.body):e.body}`);const r=i(e);return r?Promise.reject(r):e}catch(r){return t.error(r),e}}const f=(n,f)=>{let p;let h;f=((r,n)=>{let s="object"==typeof n?{headers:{},...n}:{url:n,headers:{}};if(s.method||(s.method=r),s=o(s),!0===s.rewrite&&(e.isSurge?(s.headers["X-Surge-Skip-Scripting"]=!1,delete s.rewrite):e.isQuanX&&(s.hints=!1,delete s.rewrite)),e.isSurgeLike){const e=s.headers["content-type"]||s.headers["Content-Type"];"GET"!==s.method&&e&&e.indexOf("application/json")>=0&&s.body instanceof Array&&(s.body=JSON.stringify(s.body),t.debug(`Convert Array object to String: ${s.body}`))}else e.isQuanX?(s.hasOwnProperty("body")&&"string"!=typeof s.body&&(s.body=JSON.stringify(s.body)),s.method=r):e.isNode&&("POST"===r||"PUT"===r||"PATCH"===r||"DELETE"===r?s.data=s.data||s.body:"GET"===r&&(s.params=s.params||s.body),delete s.body);return s})(n.toUpperCase(),f),p=e.isNode?r:e.isSurgeLike?e=>new Promise(((t,r)=>{$httpClient[n.toLowerCase()](e,((n,o,i)=>{if(n){let t={name:n.name||n,message:n.message||n,stack:n.stack||n,config:e,response:s(o)};r(t)}else o.config=e,o.body=i,t(o)}))})):e=>new Promise(((t,r)=>{$task.fetch(e).then((r=>{r=s(r,e);const n=i(r,e);if(n)return Promise.reject(n);t(r)})).catch((t=>{let n={name:t.message||t.error,message:t.message||t.error,stack:t.error,config:e,response:t.response?s(t.response):null};r(n)}))})),(e=>{try{d=[],l=[],a.request.forEach((t=>{"function"==typeof t.runWhen&&!1===t.runWhen(e)||(u=u&&t.synchronous,d.unshift(t.fulfilled,t.rejected))})),a.response.forEach((e=>{l.push(e.fulfilled,e.rejected)}))}catch(e){t.error(`Failed to register interceptors: ${e}.`)}})(f);const y=[c,void 0],$=[g,void 0];if(u){for(t.debug("Interceptors are executed in synchronous mode"),Array.prototype.unshift.apply(d,y),d=d.concat([c,void 0]);d.length;){let e=d.shift(),r=d.shift();try{"function"==typeof e&&t.debug(`Executing request fulfilled ${e.name}`),f=e(f)}catch(e){"function"==typeof r&&t.debug(`Executing request rejected ${r.name}`),r(e);break}}try{h=!e.isNode&&f.timeout?m(f):p(f)}catch(e){return Promise.reject(e)}for(Array.prototype.unshift.apply(l,$);l.length;)h=h.then(l.shift(),l.shift());return h}{t.debug("Interceptors are executed in asynchronous mode");let r=[p,void 0];for(Array.prototype.unshift.apply(r,y),Array.prototype.unshift.apply(r,d),r=r.concat($),r=r.concat(l),h=Promise.resolve(f);r.length;)try{let n=r.shift(),o=r.shift();!e.isNode&&f.timeout&&n===p&&(n=m),"function"==typeof n&&t.debug(`Executing request fulfilled ${n.name}`),"function"==typeof o&&t.debug(`Executing request rejected ${o.name}`),h=h.then(n,o)}catch(e){t.error(`request exception: ${e}`)}return h}function m(e){try{const t=new Promise(((t,r)=>{setTimeout((()=>{let t={message:`timeout of ${e.timeout}ms exceeded.`,config:e};r(t)}),e.timeout)}));return Promise.race([p(e),t])}catch(e){t.error(`Request Timeout exception: ${e}.`)}}};return{request:f,interceptors:a,convertHeadersToLowerCase:e=>Object.keys(e).reduce(((t,r)=>(t[r.toLowerCase()]=e[r],t)),{}),convertHeadersToCamelCase:e=>Object.keys(e).reduce(((t,r)=>(t[r.split("-").map((e=>e[0].toUpperCase()+e.slice(1))).join("-")]=e[r],t)),{}),modifyResponse:s,get:e=>f("GET",e),post:e=>f("POST",e),put:e=>f("PUT",e),patch:e=>f("PATCH",e),delete:e=>f("DELETE",e),head:e=>f("HEAD",e),options:e=>f("OPTIONS",e)}}(async()=>{let e=null;$.isResponse?e=await handleRequest("resp_handlers"):$.isRequest?e=await handleRequest("req_handlers"):($.data.del(currentUserInfoKey),$.data.del(blockedUsersKey),$.data.del(keywordBlockKey),$.notification.post("哲也同学数据清理完毕")),e?$.done(e):$.done()})();